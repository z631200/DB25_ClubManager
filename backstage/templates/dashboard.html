{% extends "backstage.html" %}
{% block head %}
{{ super() }}
{% endblock head %}
{% block title %}後台資料分析{% endblock title%}
{% block content %}

<div class="my-3 p-3 bg-body rounded shadow-sm">
  <!-- Dashboard -->
  <div id="dashboard">
    <nav>
      <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <button class="nav-link active" id="tab-participants" data-bs-toggle="tab" data-bs-target="#pane-participants" type="button" role="tab" aria-controls="pane-participants" aria-selected="true">活動參與人數</button>
        <button class="nav-link" id="tab-activity-detail" data-bs-toggle="tab" data-bs-target="#pane-activity-detail" type="button" role="tab" aria-controls="pane-activity-detail" aria-selected="false">活動節目明細</button>
        <button class="nav-link" id="tab-equipment-usage" data-bs-toggle="tab" data-bs-target="#pane-equipment-usage" type="button" role="tab" aria-controls="pane-equipment-usage" aria-selected="false">節目器材使用</button>
        <button class="nav-link" id="tab-equipment-belongs" data-bs-toggle="tab" data-bs-target="#pane-equipment-belongs" type="button" role="tab" aria-controls="pane-equipment-belongs" aria-selected="false">負責器材</button>
        <button class="nav-link" id="tab-department-count" data-bs-toggle="tab" data-bs-target="#pane-department-count" type="button" role="tab" aria-controls="pane-department-count" aria-selected="false">單一活動各系所參與人數</button>
        <button class="nav-link" id="tab-student" data-bs-toggle="tab" data-bs-target="#pane-student" type="button" role="tab" aria-controls="pane-student" aria-selected="false">學生參與查詢</button>
      </div>
    </nav>
  </div>

  <br/>

  <div class="tab-content" id="nav-tabContent">
    <!-- 活動參與人數 -->
    <div class="tab-pane fade show active" id="pane-participants" role="tabpanel" aria-labelledby="tab-participants">
      <center>
        <div id="chart-participants" class="container-fluid" style=" height: 500px;"></div>
      </center>
      <!-- <div class="table-responsive mt-3">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>活動名稱</th>
              <th>參加人數</th>
            </tr>
          </thead>
          <tbody>
            {% for r in participants_data %}
            <tr>
              <td>{{ r.活動名稱 }}</td>
              <td>{{ r.參加人數 }}</td>
            </tr>
            {% endfor %}
            {% if participants_data|length == 0 %}
            <tr><td colspan="2" class="text-center text-muted">目前沒有資料</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div> -->
    </div>

    <!-- 活動節目明細 -->
    <div class="tab-pane fade" id="pane-activity-detail" role="tabpanel" aria-labelledby="tab-activity-detail">
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>活動名稱</th>
              <th>節目名稱</th>
              <th>節目時間</th>
              <th>表演者</th>
            </tr>
          </thead>
          <tbody>
            {% for r in activity_detail %}
            <tr>
              <td>{{ r.活動名稱 }}</td>
              <td>{{ r.節目名稱 }}</td>
              <td>{{ r.時間 }}</td>
              <td>{{ r.表演者 }}</td>
            </tr>
            {% endfor %}
            {% if activity_detail|length == 0 %}
            <tr><td colspan="3" class="text-center text-muted">目前沒有資料</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 節目器材使用 -->
    <div class="tab-pane fade" id="pane-equipment-usage" role="tabpanel" aria-labelledby="tab-equipment-usage">
      <center>
        <div id="chart-equipment" class="container-fluid" style="height: 500px;"></div>
      </center>
      <!-- <div class="table-responsive mt-3">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>節目名稱</th>
              <th>器材名稱</th>
              <th>數量</th>
            </tr>
          </thead>
          <tbody>
            {% for r in equipment_usage %}
            <tr>
              <td>{{ r.節目名稱 }}</td>
              <td>{{ r.器材名稱 }}</td>
              <td>{{ r.數量 }}</td>
            </tr>
            {% endfor %}
            {% if equipment_usage|length == 0 %}
            <tr><td colspan="3" class="text-center text-muted">目前沒有資料</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <small class="text-muted">圖表為前端將同一節目各器材「數量」加總之視覺化。</small> -->
    </div>

    <!-- 後勤歸屬 -->
    <div class="tab-pane fade" id="pane-equipment-belongs" role="tabpanel" aria-labelledby="tab-equipment-belongs">
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>組別</th>
              <th>器材名稱</th>
              <th>成員</th>
            </tr>
          </thead>
          <tbody>
            {% for r in equipment_belongs %}
            <tr>
              <td>{{ r.組別 }}</td>
              <td>{{ r.器材名稱 if r.器材名稱 else '-' }}</td>
              <td>{{ r.成員 if r.成員 else '-' }}</td>
            </tr>
            {% endfor %}
            {% if equipment_belongs|length == 0 %}
            <tr><td colspan="3" class="text-center text-muted">目前沒有資料</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 學生參與查詢 -->
    <div class="tab-pane fade" id="pane-student" role="tabpanel" aria-labelledby="tab-student">
      <form class="row g-3 mb-3" method="get" action="{{ url_for('analysis_new.dashboard') }}">
        <div class="col-auto">
          <label for="sName" class="col-form-label">學生姓名</label>
        </div>
        <div class="col-auto">
          <input type="text" class="form-control" id="sName" name="sName" placeholder="例如：王小明" value="{{ sName }}">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">查詢</button>
        </div>
        {% if sName %}
        <div class="col-12">
          <span class="badge bg-secondary">目前查詢：{{ sName }}</span>
        </div>
        {% endif %}
      </form>

      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>學號</th>
              <th>學生</th>
              <th>活動名稱</th>
            </tr>
          </thead>
          <tbody>
            {% for r in student_participation %}
            <tr>
              <td>{{ r.學號 }}</td>
              <td>{{ r.學生 }}</td>
              <td>{{ r.活動名稱 }}</td>
            </tr>
            {% endfor %}
            {% if student_participation|length == 0 %}
            <tr><td colspan="3" class="text-center text-muted">尚未查詢或無資料</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 單一活動各系所參與人數 -->
    <div class="tab-pane fade" id="pane-department-count" role="tabpanel" aria-labelledby="tab-department-count">
      <form class="row g-3 mb-3" method="get" action="{{ url_for('analysis_new.dashboard') }}">
        <div class="col-auto">
          <label for="aSeq" class="col-form-label">活動編號</label>
        </div>
        <div class="col-auto">
          <input type="text" class="form-control" id="aSeq" name="aSeq" placeholder="例如：A001" value="{{ aSeq }}">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">查詢</button>
        </div>
        {% if aSeq %}
        <div class="col-12">
          <span class="badge bg-secondary">目前查詢活動：{{ aSeq }}</span>
        </div>
        {% endif %}
      </form>

      <!-- 圖表 -->
      <center>
        <div id="chart-department" class="container-fluid" style="height: 500px;"></div>
      </center>

      <!-- 表格 -->
      <!-- <div class="table-responsive mt-3">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>活動編號</th>
              <th>活動名稱</th>
              <th>系所</th>
              <th>人數</th>
            </tr>
          </thead>
          <tbody>
            {% for r in department_count %}
            <tr>
              <td>{{ r.活動編號 }}</td>
              <td>{{ r.活動名稱 }}</td>
              <td>{{ r.系所 }}</td>
              <td>{{ r.人數 }}</td>
            </tr>
            {% endfor %}
            {% if department_count|length == 0 %}
            <tr><td colspan="4" class="text-center text-muted">尚未查詢或無資料</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div> -->
    </div>

  </div>
</div>

<!-- ECharts -->
<script>
  // 後端資料
  const participants = JSON.parse('{{ participants_data | tojson | safe }}');
  const equipmentUsageRows = JSON.parse('{{ equipment_usage | tojson | safe }}');

  // ========= 圖 1：各活動參與人數 =========
  const actNames = participants.map(d => d['活動名稱']);
  const actCounts = participants.map(d => d['參加人數']);

  const chartDoma = document.getElementById('chart-participants');
  const myCharta = echarts.init(chartDoma);

  const optiona = {
    title: { text: '各活動參與人數' },
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: actNames },
    yAxis: { type: 'value', name: '人數', minInterval: 1 },
    series: [{
      name: '參加人數',
      type: 'bar',
      data: actCounts,
      label: { show: true, position: 'top' },
      markPoint: { data: [{type: 'max', name: '最高'}, {type: 'min', name: '最低'}] }
    }],
    grid: { left: 50, right: 30, bottom: 60, top: 60 }
  };

  // ========= 圖 2：各節目器材總量（前端彙總） =========
  const usageByProgram = {};
  equipmentUsageRows.forEach(r => {
    const prog = r['節目名稱'] || '(未命名節目)';
    const qty = Number(r['數量'] || 0);
    usageByProgram[prog] = (usageByProgram[prog] || 0) + qty;
  });

  const programNames = Object.keys(usageByProgram);
  const programTotals = programNames.map(k => usageByProgram[k]);

  const chartDomb = document.getElementById('chart-equipment');
  const myChartb = echarts.init(chartDomb);

  const optionb = {
    title: { text: '各節目器材總量（加總視覺化）' },
    tooltip: { trigger: 'axis' },
    xAxis: {
      type: 'category',
      data: programNames,
      axisLabel: {
        interval: 0,
        rotate: 45,
        hideOverlap: true,
        formatter: (val) => (val.length > 16 ? val.slice(0, 16) + '…' : val)
      }
    },
    yAxis: { type: 'value', name: '器材數量' },
    series: [{
      name: '器材總量',
      type: 'bar',
      data: programTotals,
      label: { show: true, position: 'top' }
    }],
    grid: { left: 50, right: 30, bottom: 110, top: 60 }
  };


  optiona && myCharta.setOption(optiona);
  optionb && myChartb.setOption(optionb);

  const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
  tabEls.forEach(el => {
    el.addEventListener('shown.bs.tab', () => {
      myCharta.resize();
      myChartb.resize();
    });
  });

  window.addEventListener('resize', () => {
    myCharta.resize();
    myChartb.resize();
  });
  
  const currentSName = "{{ sName }}";
  if (currentSName && currentSName.trim() !== "") {
    const tabStudentTrigger = document.querySelector('#tab-student');
    if (tabStudentTrigger) {
      const tab = new bootstrap.Tab(tabStudentTrigger);
      tab.show();
    }
    if (window.history.replaceState) {
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);
    }
  }

  // ======== 圖 3：單一活動各系所參與人數（圓餅圖） ========
  const deptRows = JSON.parse('{{ department_count | tojson | safe }}');   // 後端傳入
  const deptLabels = deptRows.map(r => r['系所']);
  const deptCounts = deptRows.map(r => Number(r['人數'] || 0));

  const chartDomc = document.getElementById('chart-department');
  const myChartc = echarts.init(chartDomc);

  // 將資料組成 ECharts pie 格式
  const pieData = deptRows.map(r => ({
    name: r['系所'],
    value: Number(r['人數'] || 0)
  }));

  const optionc = {
    title: { 
      text: '單一活動各系所參與人數（圓餅圖）',
      left: 'center'
    },
    tooltip: { 
      trigger: 'item',
      formatter: '{b}：{c} 人 ({d}%)'
    },
    legend: { 
      orient: 'vertical',
      left: 'left',
      top: 'middle'
    },
    series: [{
      name: '系所',
      type: 'pie',
      radius: ['35%', '70%'], // 內外半徑，可調整成甜甜圈圖效果
      avoidLabelOverlap: false,
      label: {
        show: true,
        formatter: '{b}: {c}人\n({d}%)'
      },
      labelLine: { show: true },
      data: pieData
    }],
    color: [
      '#5470C6', '#91CC75', '#EE6666', '#73C0DE',
      '#FAC858', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'
    ]
  };

  optionc && myChartc.setOption(optionc);

  // 讓切換分頁時自動重繪三張圖
  const tabEls2 = document.querySelectorAll('button[data-bs-toggle="tab"]');
  tabEls2.forEach(el => {
    el.addEventListener('shown.bs.tab', () => {
      myCharta.resize();
      myChartb.resize();
      myChartc.resize();
    });
  });

  // 監聽視窗縮放
  window.addEventListener('resize', () => {
    myCharta.resize();
    myChartb.resize();
    myChartc.resize();
  });

  // 如果 URL 帶有 aSeq，就自動切到「單一活動各系所參與人數」分頁
  const currentASeq = "{{ aSeq }}";
  if (currentASeq && currentASeq.trim() !== "") {
    const tabDeptTrigger = document.querySelector('#tab-department-count');
    if (tabDeptTrigger) {
      const tab = new bootstrap.Tab(tabDeptTrigger);
      tab.show();
    }
    // 清理 URL（避免重新整理又觸發）
    if (window.history.replaceState) {
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);
    }
  }

</script>

{% endblock content %}
